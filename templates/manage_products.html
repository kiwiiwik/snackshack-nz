<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .table-card { border-radius: 15px; border: none; }
        /* Virtual Keyboard Styles */
        .keyboard-container { background: #dee2e6; padding: 15px; border-radius: 0 0 20px 20px; border-top: 2px solid #ced4da; user-select: none; }
        .keyboard-row { display: flex; justify-content: center; margin-bottom: 8px; gap: 6px; }
        .key { height: 60px; min-width: 45px; background: white; border: 1px solid #adb5bd; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; flex-grow: 1; transition: 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .key:active { background: #0d6efd; color: white; transform: scale(0.95); }
        .key.wide { flex-grow: 3; background: #f8f9fa; }
        .key.extra-wide { flex-grow: 12; }
        .key.special { background: #adb5bd; color: white; }
        .version-tag { font-size: 0.65rem; color: #adb5bd; position: fixed; bottom: 10px; right: 15px; }
        .vk-input:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }
        .touch-action { min-width: 48px; min-height: 48px; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .touch-action:active { transform: scale(0.92); }
        .btn-close { width: 48px; height: 48px; padding: 16px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold fs-4" href="/"><i class="fas fa-arrow-left me-2"></i> Back to Kiosk</a>
        <button class="btn btn-success shadow-sm fw-bold py-2 px-4" data-bs-toggle="modal" data-bs-target="#editModal" onclick="clearForm()"><i class="fas fa-plus me-1"></i> Add New Item</button>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="card table-card shadow-sm"><div class="card-body p-0"><table class="table table-hover align-middle mb-0">
        <thead class="table-light"><tr><th style="width:60px;"></th><th>UPC / PLU</th><th>Brand</th><th>Description</th><th>Price</th><th>Stock</th><th class="text-end px-4">Actions</th></tr></thead>
        <tbody>{% for p in products %}<tr>
            <td><img src="{{ url_for('main.product_image', upc=p.upc_code) }}" onerror="this.src='/static/images/placeholder.png';" alt="" style="width:44px;height:44px;object-fit:contain;border-radius:6px;border:1px solid #eee;"></td>
            <td><code>{{ p.upc_code }}</code></td><td>{{ p.manufacturer or '-' }}</td><td class="fw-bold">{{ p.description }}</td><td class="text-success fw-bold">${{ "%.2f"|format(p.price) }}</td>
            <td><span class="badge bg-light text-dark border">{{ p.stock_level }}</span></td>
            <td class="text-end px-4">
                <button type="button" class="btn btn-outline-primary shadow-sm touch-action" data-bs-toggle="modal" data-bs-target="#editModal" onclick='editProduct({{ p.to_dict() | tojson }})'><i class="fas fa-edit"></i></button>
                <a href="{{ url_for('main.delete_product', upc=p.upc_code or 'UNKNOWN') }}" class="btn btn-outline-danger shadow-sm ms-2 touch-action" onclick="return confirm('Delete item?')"><i class="fas fa-trash"></i></a>
            </td>
        </tr>{% endfor %}</tbody>
    </table></div></div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <form action="{{ url_for('main.save_product_manual') }}" method="POST" enctype="multipart/form-data" class="modal-content shadow-lg border-0" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header border-0 pb-0"><h5 class="fw-bold" id="modalTitle">Item Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label small fw-bold text-muted text-uppercase">UPC / PLU CODE</label>
                    <input type="text" name="upc_code" id="formUPC" class="form-control vk-input" required onkeydown="if(event.key==='Enter'){event.preventDefault();lookupProductManual(this.value);}">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="form-label small fw-bold text-muted text-uppercase">Category</label>
                        <select name="category" id="formCat" class="form-select" onchange="if(this.value==='__new__'){this.style.display='none';document.getElementById('newCatWrap').style.display='flex';}">
                            {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                            <option value="__new__">+ Add new...</option>
                        </select>
                        <div id="newCatWrap" style="display:none;" class="input-group">
                            <input type="text" id="newCatInput" class="form-control vk-input" placeholder="New category">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="var s=document.getElementById('formCat'),v=document.getElementById('newCatInput').value.trim();if(v){var o=new Option(v,v);s.add(o,s.options.length-1);s.value=v;}s.style.display='';document.getElementById('newCatWrap').style.display='none';">OK</button>
                        </div>
                    </div>
                    <div class="col-6"><label class="form-label small fw-bold text-muted text-uppercase">Price ($)</label>
                        <input type="number" step="0.01" name="price" id="formPrice" class="form-control vk-input">
                    </div>
                </div>
                <div class="mb-3"><label class="form-label small fw-bold text-muted text-uppercase">Brand</label><input type="text" name="manufacturer" id="formMfg" class="form-control vk-input"></div>
                <div class="mb-3"><label class="form-label small fw-bold text-muted text-uppercase">Description</label><input type="text" name="description" id="formDesc" class="form-control vk-input" required></div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="form-label small fw-bold text-muted text-uppercase">Size</label><input type="text" name="size" id="formSize" class="form-control vk-input"></div>
                    <div class="col-6"><label class="form-label small fw-bold text-muted text-uppercase">Current Stock</label><input type="number" name="stock_level" id="formStock" class="form-control vk-input"></div>
                </div>
                <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" name="is_quick_item" id="formQuick"><label class="form-check-label small fw-bold" for="formQuick">Show on Kiosk Menu</label></div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted text-uppercase">Product Image</label>
                    <div id="pasteZone" tabindex="0" style="border:2px dashed #dee2e6;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:border-color 0.2s,background 0.2s;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;">
                        <div id="imagePreviewBox" style="display:none;">
                            <img id="imagePreview" src="" alt="Preview" style="max-width:120px;max-height:120px;object-fit:contain;border:1px solid #dee2e6;border-radius:8px;padding:4px;">
                        </div>
                        <div id="pasteHint" class="text-muted" style="font-size:0.85rem;">
                            <i class="fas fa-paste me-1"></i> Paste image (Ctrl+V) or drag &amp; drop<br>
                            <span style="font-size:0.8rem;color:#adb5bd;">or use the file picker below</span>
                        </div>
                    </div>
                    <input type="file" name="product_image" id="formImage" class="form-control mt-2" accept="image/png,image/jpeg,image/gif,image/webp">
                    <div class="form-text">PNG, JPG, GIF or WebP. Max 2 MB.</div>
                </div>
                <input type="hidden" name="image_base64" id="formImageBase64" value="">
                <button type="submit" class="btn btn-primary w-100 py-3 shadow fw-bold mb-2">SAVE CHANGES</button>
            </div>
            
            <div id="keyboard" class="keyboard-container">
                <div class="keyboard-row" id="row-nums"></div>
                <div class="keyboard-row" id="row-1"></div>
                <div class="keyboard-row" id="row-2"></div>
                <div class="keyboard-row" id="row-3"></div>
                <div class="keyboard-row">
                    <div class="key wide special" onclick="toggleShift()">SHIFT</div>
                    <div class="key extra-wide" onclick="addKey(' ')">SPACE</div>
                    <div class="key wide special" onclick="backspace()"><i class="fas fa-backspace"></i></div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="version-tag">Manager v1.5.3</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let activeInput = null;
    let isShift = false;
    const keys = [
        {row: 'row-nums', val: '1234567890'},
        {row: 'row-1', val: 'qwertyuiop'},
        {row: 'row-2', val: 'asdfghjkl'},
        {row: 'row-3', val: 'zxcvbnm.'}
    ];

    function renderKeyboard() {
        keys.forEach(k => {
            const container = document.getElementById(k.row);
            container.innerHTML = '';
            k.val.split('').forEach(char => {
                const display = isShift ? char.toUpperCase() : char;
                container.innerHTML += `<div class="key" onclick="addKey('${display}')">${display}</div>`;
            });
        });
    }

    function addKey(char) { if(activeInput) { activeInput.value += char; activeInput.dispatchEvent(new Event('input')); activeInput.focus(); }}
    function backspace() { if(activeInput) { activeInput.value = activeInput.value.slice(0, -1); activeInput.dispatchEvent(new Event('input')); activeInput.focus(); }}
    function toggleShift() { isShift = !isShift; renderKeyboard(); }

    // Use event delegation for better touch support
    document.addEventListener('focusin', (e) => {
        if (e.target.classList.contains('vk-input')) {
            activeInput = e.target;
            document.getElementById('keyboard').style.display = 'block';
        }
    });

    function clearForm() {
        const upc = document.getElementById('formUPC');
        upc.value = ""; upc.readOnly = false;
        document.getElementById('modalTitle').innerText = "Add New Item";
        document.getElementById('formDesc').value = ""; document.getElementById('formMfg').value = "";
        document.getElementById('formSize').value = ""; document.getElementById('formPrice').value = "2.50";
        document.getElementById('formStock').value = "0"; document.getElementById('formQuick').checked = true;
        document.getElementById('formImage').value = "";
        document.getElementById('formImageBase64').value = "";
        document.getElementById('imagePreviewBox').style.display = "none";
        setTimeout(() => { upc.focus(); }, 500);
    }

    function editProduct(p) {
        const upc = document.getElementById('formUPC');
        upc.value = p?.upc_code ?? ""; upc.readOnly = true;
        document.getElementById('modalTitle').innerText = "Item Details";
        document.getElementById('formCat').value = p?.category ?? "Snacks";
        document.getElementById('formMfg').value = p?.manufacturer ?? "";
        document.getElementById('formDesc').value = p?.description ?? "";
        document.getElementById('formSize').value = p?.size ?? "";
        document.getElementById('formPrice').value = (p?.price ?? "");
        document.getElementById('formStock').value = (p?.stock_level ?? "");
        document.getElementById('formQuick').checked = !!p?.is_quick_item;
        document.getElementById('formImage').value = "";
        document.getElementById('formImageBase64').value = "";
        if (p?.upc_code) {
            document.getElementById('imagePreview').src = "/product_image/" + p.upc_code;
            document.getElementById('imagePreviewBox').style.display = "block";
        } else {
            document.getElementById('imagePreviewBox').style.display = "none";
        }
        setTimeout(() => { document.getElementById('formDesc').focus(); }, 500);
    }

    // --- Image paste / drop / file-pick support ---
    const pasteZone = document.getElementById('pasteZone');
    const formImage = document.getElementById('formImage');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewBox = document.getElementById('imagePreviewBox');

    function applyImageFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        if (file.size > 2 * 1024 * 1024) { alert('Image must be under 2 MB.'); return; }
        try {
            const dt = new DataTransfer();
            dt.items.add(file);
            formImage.files = dt.files;
        } catch(e) { /* DataTransfer not supported */ }
        const reader = new FileReader();
        reader.onload = function(ev) {
            imagePreview.src = ev.target.result;
            imagePreviewBox.style.display = 'block';
            // Store base64 as fallback for paste/drop (in case file input wasn't set)
            document.getElementById('formImageBase64').value = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Paste anywhere in the modal
    document.getElementById('editModal').addEventListener('paste', function(e) {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.startsWith('image/')) {
                e.preventDefault();
                applyImageFile(items[i].getAsFile());
                return;
            }
        }
    });

    // Drag & drop on the paste zone
    pasteZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = '#0d6efd';
        this.style.background = '#f0f6ff';
    });
    pasteZone.addEventListener('dragleave', function() {
        this.style.borderColor = '#dee2e6';
        this.style.background = '';
    });
    pasteZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = '#dee2e6';
        this.style.background = '';
        const file = e.dataTransfer.files[0];
        if (file) applyImageFile(file);
    });

    // Click paste zone to open file picker
    pasteZone.addEventListener('click', function() { formImage.click(); });

    // File input change
    formImage.addEventListener('change', function(e) {
        if (e.target.files[0]) applyImageFile(e.target.files[0]);
    });

    async function lookupProductManual(code) { 
        if (!code || document.getElementById('formUPC').readOnly) return; 
        document.getElementById('formDesc').placeholder = "Searching..."; 
        try { 
            const res = await fetch(`/admin/get-product/${code}`); 
            const data = await res.json(); 
            if (data.found) { 
                document.getElementById('formMfg').value = data.mfg || ""; 
                document.getElementById('formDesc').value = data.desc || ""; 
                document.getElementById('formSize').value = data.size || ""; 
                document.getElementById('formPrice').focus(); 
            } 
        } catch (e) { console.error("Lookup failed", e); } 
    }
    renderKeyboard();
</script>
</body>
</html>