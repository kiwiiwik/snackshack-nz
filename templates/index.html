<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Snack Shack NZ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; } 
        .user-tile { transition: 0.2s; border-radius: 15px; cursor: pointer; border: none; position: relative; }
        .user-tile:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .initial-avatar { width: 70px; height: 70px; background: #0d6efd; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-weight: bold; font-size: 1.5rem; }
        .product-img { width: 100%; height: 100px; object-fit: contain; padding: 5px; }
        .price-text { color: #198754; font-weight: bold; font-size: 1rem; }
        .switchboard-btn { height: 180px; border-radius: 25px; font-size: 1.5rem; font-weight: bold; transition: 0.2s; border: none; width: 100%; color: white; }
        .switchboard-btn:active { transform: scale(0.95); }
        .audit-btn-large { height: 110px; font-size: 1.2rem; font-weight: bold; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border: none; width: 100%; }
        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .num-btn { height: 60px; font-size: 1.3rem; font-weight: bold; border-radius: 10px; border: 1px solid #dee2e6; background: white; }
        .num-btn:active { background: #e9ecef; }
        .field-label { font-size: 0.7rem; font-weight: bold; color: #6c757d; text-transform: uppercase; margin-bottom: 2px; }
        .fixed-transaction-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1030; }
        .recent-audit-item { font-size: 0.85rem; border-left: 4px solid #198754; background: #fdfdfd; padding: 8px; margin-bottom: 8px; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">ü•ù Snack Shack</a>
        {% if user %}
        <div class="d-flex align-items-center">
            {% if user.is_admin %}
                <button class="btn btn-sm btn-outline-dark me-3" data-bs-toggle="modal" data-bs-target="#switchboardModal"><i class="fas fa-user-shield me-1"></i> Admin Tools</button>
            {% endif %}
            <span class="me-3">Hi, <strong>{{ user.first_name }}</strong></span>
            <span class="badge {{ 'bg-danger' if user.balance < 0 else 'bg-success' }} p-2 me-3">${{ "%.2f"|format(user.balance) }}</span>
            <a href="{{ url_for('main.logout') }}" class="btn btn-sm btn-outline-danger">Logout</a>
        </div>
        {% endif %}
    </div>
</nav>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}{% for cat, msg in messages %}<div class="alert alert-{{ cat }} shadow-sm text-center">{{ msg }}</div>{% endfor %}{% endif %}
    {% endwith %}

    {% if not user %}
        <h4 class="text-center mb-5 text-secondary">Select User</h4>
        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4 mb-5">
            {% for u in users %}<div class="col"><a href="{{ url_for('main.manual_add', barcode=u.card_id or '') }}" class="text-decoration-none text-dark"><div class="card h-100 p-4 user-tile text-center shadow-sm">{% if u.is_admin %}<i class="fas fa-shield-alt admin-badge"></i>{% endif %}<div class="initial-avatar">{{ u.first_name[0] }}</div><div class="fw-bold">{{ u.first_name }} {{ u.last_name }}</div></div></a></div>{% endfor %}
        </div>
    {% else %}
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            {% for category in grouped_products.keys() %}
            <li class="nav-item" role="presentation"><button class="nav-link {{ 'active' if loop.first }}" id="tab-{{ loop.index }}" data-bs-toggle="pill" data-bs-target="#cat-{{ loop.index }}" type="button">{{ category }}</button></li>
            {% endfor %}
        </ul>
        <div class="tab-content">
            {% for category, items in grouped_products.items() %}
            <div class="tab-pane fade {{ 'show active' if loop.first }}" id="cat-{{ loop.index }}"><div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3 mb-4">
                {% for p in items %}<div class="col"><a href="{{ url_for('main.manual_add', barcode=p.upc_code) }}" class="text-decoration-none text-dark"><div class="card h-100 text-center border-0 shadow-sm p-3 user-tile"><span class="badge bg-light text-dark border mb-2">{{ p.stock_level }} left</span><img src="{{ url_for('static', filename='images/' + (p.image_url or 'placeholder.png')) }}" class="product-img mb-2" onerror="this.src='/static/images/placeholder.png';"><div class="fw-bold small">{{ p.description }}</div><div class="price-text">${{ "%.2f"|format(p.price) }}</div></div></a></div>{% endfor %}
            </div></div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<div class="modal fade" id="switchboardModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-body p-5 text-center">
                <h2 class="fw-bold mb-5 text-dark">Admin Switchboard</h2>
                <div class="row g-4">
                    <div class="col-md-6"><button class="switchboard-btn bg-danger" data-bs-toggle="modal" data-bs-target="#auditModal"><i class="fas fa-clipboard-check mb-3 fa-2x"></i><br>AUDIT STATION</button></div>
                    <div class="col-md-6"><a href="{{ url_for('main.manage_products') }}" class="btn switchboard-btn bg-dark d-flex flex-column align-items-center justify-content-center text-decoration-none"><i class="fas fa-boxes mb-3 fa-2x"></i><br>PRODUCT MANAGER</a></div>
                </div>
                <div class="mt-5"><a href="{{ url_for('main.clear_audit_history') }}" class="text-muted small text-decoration-none" onclick="return confirm('Clear recent items list?')"><i class="fas fa-trash-alt me-1"></i> Clear Audit Session History</a></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="auditModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0"><h5 class="fw-bold">Audit Station</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-3">
                        <button onclick="focusScanField()" class="audit-btn-large bg-danger mb-2 shadow-sm"><i class="fas fa-barcode mb-1"></i> Scan Barcode</button>
                        <button onclick="generatePLU()" class="audit-btn-large bg-secondary mb-4 shadow-sm"><i class="fas fa-plus-circle mb-1"></i> No Barcode?</button>
                        <div class="num-pad bg-light p-3 rounded">
                            <button class="num-btn" onclick="numPress('1')">1</button><button class="num-btn" onclick="numPress('2')">2</button><button class="num-btn" onclick="numPress('3')">3</button>
                            <button class="num-btn" onclick="numPress('4')">4</button><button class="num-btn" onclick="numPress('5')">5</button><button class="num-btn" onclick="numPress('6')">6</button>
                            <button class="num-btn" onclick="numPress('7')">7</button><button class="num-btn" onclick="numPress('8')">8</button><button class="num-btn" onclick="numPress('9')">9</button>
                            <button class="num-btn" onclick="numPress('0')">0</button><button class="num-btn text-primary" onclick="numPress('*')">x</button><button class="num-btn text-danger" onclick="numPress('C')">C</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <form action="{{ url_for('main.audit_submit') }}" method="POST" id="auditForm">
                            <div class="card border-0 p-4 h-100 shadow-sm">
                                <div class="mb-3"><div class="field-label">UPC / PLU Code</div><input type="text" name="barcode" id="auditBarcode" class="form-control form-control-lg bg-light fw-bold text-center" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupProduct(this.value);}"></div>
                                <div class="row g-2 mb-3"><div class="col-6"><div class="field-label">Brand</div><input type="text" name="manufacturer" id="auditMfg" class="form-control"></div><div class="col-6"><div class="field-label">Size</div><input type="text" name="size" id="auditSize" class="form-control"></div></div>
                                <div class="mb-4"><div class="field-label">Item Description</div><input type="text" name="description" id="auditDesc" class="form-control"></div>
                                <div class="row g-3 mb-4">
                                    <div class="col-6"><div class="field-label">Qty per Pack</div><input type="text" id="auditPackQty" class="form-control text-center fw-bold" value="1" onclick="setFocus('auditPackQty')"></div>
                                    <div class="col-6"><div class="field-label">Num Packs</div><input type="text" id="auditNumPacks" class="form-control text-center fw-bold" placeholder="0" onclick="setFocus('auditNumPacks')"></div>
                                </div>
                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded mb-4"><div class="field-label">Final Count</div><input type="hidden" name="final_count" id="auditFinalCount" value="0"><h1 class="display-4 fw-bold text-primary m-0" id="auditDisplayTotal">0</h1></div>
                                <button type="submit" class="audit-btn-large bg-success shadow py-4">SAVE</button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-3">
                        <h6 class="fw-bold text-muted mb-3">Recent Audits</h6>
                        <div id="auditHistory">
                            {% if recent_audits %}{% for r in recent_audits %}<div class="recent-audit-item shadow-sm"><div class="fw-bold">{{ r.description }}</div><div class="small text-muted">{{ r.stock_level }} units</div></div>{% endfor %}
                            {% else %}<div class="text-muted small">Ready for first scan...</div>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentField = "auditNumPacks"; 
    window.onload = () => { if (new URLSearchParams(window.location.search).get('open_admin')) { new bootstrap.Modal(document.getElementById('switchboardModal')).show(); } };

    function setFocus(id) { currentField = id; }
    function focusScanField() { const bc = document.getElementById('auditBarcode'); bc.value = ""; bc.focus(); }
    function generatePLU() { document.getElementById('auditBarcode').value = "PLU-" + Math.floor(1000 + Math.random() * 9999); resetCounts(); }
    async function lookupProduct(code) {
        const res = await fetch(`/admin/get-product/${code}`);
        const data = await res.json();
        if (data.found) {
            document.getElementById('auditMfg').value = data.mfg || "";
            document.getElementById('auditDesc').value = data.desc || "";
            document.getElementById('auditSize').value = data.size || "";
            document.getElementById('auditPackQty').value = "1";
            document.getElementById('auditNumPacks').value = "";
            currentField = "auditNumPacks"; document.getElementById('auditNumPacks').focus(); calcTotal();
        }
    }
    function resetCounts() { document.getElementById('auditPackQty').value = "1"; document.getElementById('auditNumPacks').value = ""; document.getElementById('auditDisplayTotal').innerText = "0"; }
    function numPress(val) {
        if (val === 'C') { resetCounts(); return; }
        if (val === '*') { currentField = "auditPackQty"; document.getElementById('auditPackQty').value = ""; return; }
        document.getElementById(currentField).value += val; calcTotal();
    }
    function calcTotal() {
        const total = (parseInt(document.getElementById('auditPackQty').value) || 1) * (parseInt(document.getElementById('auditNumPacks').value) || 0);
        document.getElementById('auditDisplayTotal').innerText = total;
        document.getElementById('auditFinalCount').value = total;
    }
</script>
</body>
</html>